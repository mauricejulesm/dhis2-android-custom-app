CREATE TABLE ProgramStageDataElement_Temp (_id INTEGER PRIMARY KEY AUTOINCREMENT, uid TEXT NOT NULL UNIQUE, code TEXT, name TEXT, displayName TEXT, created TEXT, lastUpdated TEXT, displayInReports INTEGER, compulsory INTEGER, allowProvidedElsewhere INTEGER, sortOrder INTEGER, allowFutureDate INTEGER, dataElement TEXT NOT NULL, programStage TEXT NOT NULL, FOREIGN KEY (programStage) REFERENCES ProgramStage (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED, FOREIGN KEY (dataElement) REFERENCES DataElement (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED);
INSERT INTO ProgramStageDataElement_Temp SELECT _id, uid, code, name, displayName, created, lastUpdated, displayInReports, compulsory, allowProvidedElsewhere, sortOrder, allowFutureDate, dataElement, programStage FROM ProgramStageDataElement;
CREATE TABLE ProgramStageSectionDataElementLink (_id INTEGER PRIMARY KEY AUTOINCREMENT, programStageSection TEXT NOT NULL, dataElement TEXT NOT NULL, sortOrder INTEGER NOT NULL, FOREIGN KEY (programStageSection) REFERENCES ProgramStageSection (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED, FOREIGN KEY (dataElement) REFERENCES DataElement (uid) ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED);
INSERT INTO ProgramStageSectionDataElementLink SELECT NULL, programStageSection, dataElement, _id FROM ProgramStageDataElement WHERE ProgramStageDataElement.programStageSection IS NOT NULL;
DROP TABLE ProgramStageDataElement;
ALTER TABLE ProgramStageDataElement_Temp RENAME TO ProgramStageDataElement;